#  HALO 보안 및 인증 시스템 설계

HALO는 SNS 플랫폼의 복잡한 사용자 흐름과 다양한 상태에 대응하기 위해  
보안 중심의 인증/로그인 구조와 자동 대응 설계를 포함한 기능을 직접 구축했습니다.  
기본 세션 기반 인증을 사용하되, OAuth2, 계정 복구, 자동 공격 탐지, 로그 시스템 등  
전방위적인 보안 흐름을 설계한 것이 본 프로젝트의 핵심입니다.

---

##  인증 및 로그인 흐름

### 🔑 로그인 방식

| 방식 | 설명 |
|------|------|
| **로컬 로그인** | 이메일 + 비밀번호 기반 로그인 (`passport-local`) |
| **간편 로그인** | 카카오 / 구글 OAuth2 로그인 (`passport-kakao`, `passport-google-oauth20`) |
| **세션 기반 인증** | `express-session`과 `cookie-parser`를 통한 세션 발급 및 유지 |
| **비밀번호 암호화** | `bcrypt`를 이용한 단방향 해시 + salting 적용 |
| **보안 필터링** | XSS 및 SQL Injection 방지를 위한 입력값 필터링 + Sequelize ORM 이스케이프 처리 |

---

##  사용자 상태 분기 및 복구

### 👥 계정 상태 값

| 상태 | 설명 |
|------|------|
| `NORMAL` | 일반 활성 사용자 |
| `DELETED` | 탈퇴 처리됨 (30일간 보관 후 완전 삭제 예정) |
| `SLEEP` | 휴면 계정 (장기 미접속 시 자동 전환) |
| `BANNED` | 관리자에 의해 정지된 계정 (신고 누적 등) |

### 🔄 계정 복구 기능

- **이메일 인증 기반 복구**
  - 탈퇴 계정: `/user/restore` API를 통해 이메일 인증 후 복구
  - 휴면 계정: 로그인 시 자동 전환 또는 이메일 인증 후 수동 복구
- **비밀번호 재발급**
  - 인증된 이메일로 랜덤 임시 비밀번호 전송 후 암호화 저장

---

## 👮 관리자 권한 분기 (Role System)

- 관리자 역할은 `role` 필드로 관리되며, 총 13종의 관리자 권한이 존재합니다.
- 페이지 접근은 미들웨어에서 `req.user.role`을 기준으로 분기 처리됩니다.

| Role ID | 역할 이름 | 권한 범위 |
|---------|-----------|------------|
| 1 | 마스터 관리자 | 모든 관리자 기능 접근 |
| 5 | 유저 관리자 | 유저 조회/수정/삭제 가능 |
| 6 | 보안 관리자 | 로그 열람 및 보안 분석 가능 |
| ... | ... | 기타 관리자 (업적/채팅/포스트 등) |

---

## 🧾 보안 로그 시스템

### 🗂 기록 대상 이벤트

- 회원가입
- 로그인 성공/실패 시도
- 관리자 페이지 접근
- 유저 상태 변경(삭제/정지)
- 결제 및 멤버십 변경
- 이메일 인증 및 비밀번호 재설정 요청

### 📁 저장 방식

- 로그는 `utils/logs/` 디렉토리 내 날짜별 파일로 저장됩니다.
- 향후 MongoDB 또는 블록체인 기반 로그 시스템으로 확장 예정

### 🔒 접근 제한

- 보안 로그 조회는 `보안 관리자(role=6)` 이상만 접근 가능
- 로그에는 IP, 시간, 사용자 ID, 주요 이벤트 타입이 포함됩니다.

---

## 🚨 자동 공격 탐지 시스템

HALO는 사용자의 모든 요청에 대해 **전방위적인 공격 탐지 미들웨어**를 통해  
비정상적인 접근, 자동화된 공격 시도, 위조 요청 등을 실시간으로 감지하고  
모든 이벤트를 로그로 기록하여 관리자 분석과 대응이 가능하도록 설계되었습니다.

### 🧠 감지 항목 (총 13가지 이상)

| 이벤트 | 설명 |
|--------|------|
| User-Agent 없음 | 봇 또는 자동화 도구 가능성 탐지 |
| 비인가 사용자의 민감 경로 접근 | `/admin`, `/pay` 등 직접 접근 감지 |
| 탈퇴/휴면/정지 계정 접근 | `user_status` 기준 비정상 상태 접근 차단 |
| 로그인 실패 누적 | 동일 이메일/IP 5회 이상 실패 시 탐지 |
| 3초 내 5회 이상 요청 | 자동화 도구 의심, Rate Limit 기반 감지 |
| 서명되지 않은 세션 쿠키 | 쿠키 위조 가능성 탐지 |
| Referer 불일치 | CSRF 유도 시도 감지 |
| POST/DELETE body 없음 | 스크립트 공격 가능성 탐지 |
| Content-Type 변조 | 비허용 형식(`text/xml`, `text/plain` 등) 탐지 |
| XSS 시도 | `<script>` 포함 여부 탐지 |
| SQL Injection 시도 | `' OR`, `1=1`, `UNION SELECT` 등 키워드 감지 |
| 민감 경로 반복 접근 | 특정 IP가 민감 경로를 10회 이상 접근 시 탐지 |
| 미들웨어 자체 오류 | 감지 미들웨어에서 발생한 에러도 로그화 |

### 🔧 처리 방식

- 탐지된 이벤트는 **`logService`를 통해 실시간 기록**됩니다.
- 모든 공격 로그는 **보안 관리자(role=6)** 이상만 조회 가능
- 일부 이벤트는 **중복 감지를 방지하기 위한 쿨다운** 처리 로직 포함
- 설계상 "샌드박스 격리" 기능과 연계 가능하도록 구조 설계됨  
  (현재는 경고 메시지 없이 **로그 기록 + 관리자 뷰**에서 확인 가능)


## 🔐 향후 보안 계획

- **블록체인 기반 로그 위변조 방지**: 로그를 해시체인으로 연결해 조작 불가능하게 설계 예정
- **샌드박스 환경 분기**: 고위험 IP/계정은 실제 서비스와 동일한 Fake 환경으로 유도
- **다크데이터 기반 정밀 분석 도입 예정**: 클릭속도, 마우스 동선, 키입력 패턴 수집 및 분석

---

## 📌 요약

| 카테고리 | 적용 여부 |
|----------|------------|
| 세션 기반 인증 | ✅ |
| OAuth2 로그인 | ✅ |
| 비밀번호 암호화 | ✅ |
| 계정 복구 기능 | ✅ |
| 관리자 권한 분기 | ✅ |
| 이벤트 로그 시스템 | ✅ |
| 자동 공격 탐지 | ✅ |
| 블록체인 로그 구조 | 🔜 설계 중 |

---

> 본 보안 시스템은 실제 운영 서비스 수준을 고려하여 설계되었으며,  
> 침입 대응과 보안 기록을 중시하는 구조로 구성되어 있습니다.  
> 모든 보안 코드는 직접 구현되었으며, 외부 라이브러리 사용 시에도  
> 내부 검증 절차와 예외처리를 철저히 반영하였습니다.
